<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${playerName}">｜MoveAsYou</title>
  <style>
      .token-form {
          margin: 20px;
          padding: 20px;
      }

      .hidden {
          display: none;
      }
  </style>
  <link rel="stylesheet" href="/static/skin3d.css">
  <style th:inline="css">
      :root {
          --skin-image: url([[${playerSkin}]]);
      }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
  <header>
    <h1 th:text="${playerName}"></h1>
  </header>
  <main>
    <section th:hidden="${isOnline}">
      <p>現在サーバに居ないので表示できません</p>
    </section>
    <section th:hidden="${!isOnline}">
      <div class="token-form" id="tokenForm">
        <h2>トークンを入力してください</h2>
        <label>サーバーで発行されたトークン：<input type="text" id="tokenInput" placeholder="apple-gold-ingot"></label>
        <button onclick="connectToServer()">接続</button>
      </div>
      <div id="gameArea" class="hidden">
        <p>接続済み</p>
        <button onclick="disconnect()">切断</button>
      </div>
      <figure>
        <img th:src="${playerSkin}" id="skin-img" alt="">
        <div id="minecraft-skin">
          <div class="head cube">
            <div class="top"></div>
            <div class="bottom"></div>
            <div class="left"></div>
            <div class="right"></div>
            <div class="front"></div>
            <div class="back"></div>
            <div class="accessories">
              <div class="cube">
                <div class="top"></div>
                <div class="bottom"></div>
                <div class="left"></div>
                <div class="right"></div>
                <div class="front"></div>
                <div class="back"></div>
              </div>
            </div>
          </div>
          <div class="body cube">
            <div class="top"></div>
            <div class="bottom"></div>
            <div class="left"></div>
            <div class="right"></div>
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="arm right cube">
            <div class="top"></div>
            <div class="bottom"></div>
            <div class="left"></div>
            <div class="right"></div>
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="arm left cube">
            <div class="top"></div>
            <div class="bottom"></div>
            <div class="left"></div>
            <div class="right"></div>
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="legs left cube">
            <div class="top"></div>
            <div class="bottom"></div>
            <div class="left"></div>
            <div class="right"></div>
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="legs right cube">
            <div class="top"></div>
            <div class="bottom"></div>
            <div class="left"></div>
            <div class="right"></div>
            <div class="front"></div>
            <div class="back"></div>
          </div>
        </div>
      </figure>
    </section>

    <script th:inline="javascript">
        const DOMAIN = window.location.hostname;
        const SOCKET_PORT = /*[[${socketPort}]]*/ '';
        const PLAYER_NAME = /*[[${playerName}]]*/ '';
        
        let socket;

        function connectToServer() {
            const token = document.getElementById('tokenInput').value;
            if (!token) {
                alert('トークンを入力してください');
                return;
            }

            fetch('/auth/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    token: token,
                    playerName: PLAYER_NAME
                })
            })
                .then(response => {
                    if (response.status === 200) {
                        connectWebSocket(token);
                    } else if (response.status === 429) {
                        alert('接続数が制限を超えています。しばらく待ってから再度お試しください。');
                        connectWebSocket = undefined;
                        sendSocketMessage = undefined;
                    } else if (response.status === 400) {
                        alert('入力したトークンが有効か確認してください');
                    } else {
                        alert('不明なエラー');
                        console.error('Authentication failed with status:', response.status);
                    }
                })
                .catch(error => {
                    console.error('Authentication error:', error);
                });
        }

        function connectWebSocket(token) {
            socket = new WebSocket('ws://' + DOMAIN + ':' + SOCKET_PORT + '/socket/player/'+ PLAYER_NAME);

            // 接続時にトークンをヘッダーに設定
            socket.onopen = function() {
                socket.send('Token:' + token);
                document.getElementById('tokenForm').classList.add('hidden');
                document.getElementById('gameArea').classList.remove('hidden');
                console.info('Socket通信を開始しました');
            };

            socket.onmessage = function(event) {
                console.dir(event.data);
            };

            socket.onclose = function(event) {
                if (event.code === 4000) {
                    alert('Tokenが正しくない可能性があります');
                }
                if (event.code === 4001) {
                    alert('プレイヤーがオフラインになった可能性があります');
                }
                if(event.code === 4029){
                    alert('レート制限に抵触しています');
                    sendSocketMessage = undefined;
                    socket = null;
                    connectWebSocket = undefined;
                }
                console.warn('Socket通信が切断されました');
                document.getElementById('gameArea').classList.add('hidden');
                document.getElementById('tokenForm').classList.remove('hidden');
            };

            socket.onerror = function(error) {
                console.error('Socketエラー: ' + error);
            };
        }

        function sendSocketMessage(message) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(message);
                console.log('送信: ' + message);
                document.getElementById('messageInput').value = '';
            } else {
                alert('サーバーに接続されていません');
            }
        }

        function disconnect(){
            if (socket){
                socket.close(1000); //1000:NormalClose
            }
            socket = null;
        }
    </script>
  </main>
</body>
</html>